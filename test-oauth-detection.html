<!DOCTYPE html>
<html>
<head>
  <title>OAuth Detection Test</title>
</head>
<body>
  <h1>OAuth Auto-Detection Test</h1>
  <div id="status">Checking OAuth parameters...</div>
  <div id="session"></div>
  
  <script type="module">
    import { InsForgeClient } from './dist/index.mjs';
    
    // Simulate OAuth callback URL parameters
    const testUrl = new URL(window.location);
    testUrl.searchParams.set('access_token', 'test-token-123');
    testUrl.searchParams.set('user_id', 'user-456');
    testUrl.searchParams.set('email', 'test@example.com');
    testUrl.searchParams.set('name', 'Test User');
    testUrl.searchParams.set('email_verified', 'true');
    
    // Update URL without navigation
    window.history.replaceState({}, '', testUrl.toString());
    
    // Initialize InsForge client - should auto-detect OAuth params
    const client = new InsForgeClient({
      url: 'http://localhost:7130'
    });
    
    // Check if session was saved
    setTimeout(async () => {
      const { data } = await client.auth.getCurrentSession();
      
      const statusEl = document.getElementById('status');
      const sessionEl = document.getElementById('session');
      
      if (data?.session) {
        statusEl.textContent = '✅ OAuth parameters detected and session saved!';
        sessionEl.innerHTML = `
          <h3>Session Details:</h3>
          <pre>${JSON.stringify(data.session, null, 2)}</pre>
        `;
        
        // Check if URL was cleaned
        if (!window.location.search.includes('access_token')) {
          sessionEl.innerHTML += '<p>✅ URL cleaned of sensitive parameters</p>';
        } else {
          sessionEl.innerHTML += '<p>❌ URL still contains sensitive parameters</p>';
        }
      } else {
        statusEl.textContent = '❌ OAuth parameters not detected';
      }
    }, 100);
  </script>
</body>
</html>