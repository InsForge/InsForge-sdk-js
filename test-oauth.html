<!DOCTYPE html>
<html>
<head>
  <title>InsForge OAuth Auto-Detection Test</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 { color: #333; }
    .status {
      padding: 15px;
      margin: 20px 0;
      border-radius: 4px;
      font-weight: 500;
    }
    .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    .waiting { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px 5px;
    }
    button:hover { background: #0056b3; }
    pre {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      border: 1px solid #dee2e6;
    }
    .test-section {
      margin: 30px 0;
      padding: 20px;
      border: 1px solid #dee2e6;
      border-radius: 4px;
    }
    .check { color: #28a745; }
    .cross { color: #dc3545; }
    code {
      background: #f8f9fa;
      padding: 2px 6px;
      border-radius: 3px;
      color: #e83e8c;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîê InsForge OAuth Auto-Detection Test</h1>
    
    <div id="status" class="status info">
      Initializing test environment...
    </div>
    
    <div class="test-section">
      <h2>Test OAuth Flow</h2>
      <p>Click the button below to simulate an OAuth provider callback:</p>
      <button onclick="window.location.href='/oauth-callback-simulator'">
        üöÄ Simulate OAuth Callback
      </button>
      <button onclick="clearSession()">
        üóëÔ∏è Clear Session
      </button>
      <button onclick="checkSession()">
        üîç Check Current Session
      </button>
    </div>
    
    <div class="test-section">
      <h3>Current URL Parameters:</h3>
      <pre id="url-params">No parameters</pre>
    </div>
    
    <div class="test-section">
      <h3>Session Status:</h3>
      <div id="session-info">
        <p>No session detected</p>
      </div>
    </div>
    
    <div class="test-section">
      <h3>localStorage Contents:</h3>
      <pre id="storage-info">Empty</pre>
    </div>
  </div>
  
  <script type="module">
    import { InsForgeClient } from '/dist/index.mjs';
    
    let client;
    
    function updateStatus(message, type = 'info') {
      const status = document.getElementById('status');
      status.className = `status ${type}`;
      status.textContent = message;
    }
    
    function displayUrlParams() {
      const params = new URLSearchParams(window.location.search);
      const urlParams = document.getElementById('url-params');
      
      if (params.toString()) {
        const paramsObj = {};
        for (const [key, value] of params) {
          // Mask sensitive values for display
          if (key === 'access_token') {
            paramsObj[key] = value.substring(0, 10) + '...';
          } else {
            paramsObj[key] = value;
          }
        }
        urlParams.textContent = JSON.stringify(paramsObj, null, 2);
      } else {
        urlParams.textContent = 'No parameters (URL is clean)';
      }
    }
    
    function displayStorage() {
      const storage = document.getElementById('storage-info');
      const token = localStorage.getItem('insforge_access_token');
      const user = localStorage.getItem('insforge_user');
      
      if (token || user) {
        const data = {
          access_token: token ? token.substring(0, 20) + '...' : null,
          user: user ? JSON.parse(user) : null
        };
        storage.textContent = JSON.stringify(data, null, 2);
      } else {
        storage.textContent = 'Empty - no session stored';
      }
    }
    
    async function checkSession() {
      if (!client) return;
      
      const { data, error } = await client.auth.getCurrentSession();
      const sessionInfo = document.getElementById('session-info');
      
      if (error) {
        sessionInfo.innerHTML = `<p class="cross">‚ùå Error: ${error.message}</p>`;
        updateStatus('Failed to get session', 'error');
      } else if (data?.session) {
        sessionInfo.innerHTML = `
          <p class="check">‚úÖ Session found!</p>
          <pre>${JSON.stringify(data.session, null, 2)}</pre>
        `;
        updateStatus('Session is active', 'success');
      } else {
        sessionInfo.innerHTML = '<p>No active session</p>';
        updateStatus('No session found', 'info');
      }
      
      displayStorage();
    }
    
    window.clearSession = async function() {
      if (!client) return;
      
      await client.auth.signOut();
      localStorage.clear();
      updateStatus('Session cleared', 'info');
      await checkSession();
      displayUrlParams();
    }
    
    window.checkSession = checkSession;
    
    // Initialize on page load
    async function init() {
      displayUrlParams();
      
      // Check if we have OAuth params in URL
      const params = new URLSearchParams(window.location.search);
      const hasOAuthParams = params.has('access_token') && params.has('user_id');
      
      if (hasOAuthParams) {
        updateStatus('OAuth parameters detected! Initializing SDK...', 'waiting');
      } else {
        updateStatus('Ready for testing', 'info');
      }
      
      // Initialize InsForge client - this should auto-detect OAuth params
      client = new InsForgeClient({
        url: 'http://localhost:7130'
      });
      
      // Give it a moment for the auto-detection to complete
      setTimeout(async () => {
        if (hasOAuthParams) {
          // Check if auto-detection worked
          const { data } = await client.auth.getCurrentSession();
          
          if (data?.session) {
            updateStatus('‚úÖ OAuth auto-detection successful! Session saved automatically.', 'success');
            
            // Check if URL was cleaned
            setTimeout(() => {
              const currentParams = new URLSearchParams(window.location.search);
              if (!currentParams.has('access_token')) {
                console.log('‚úÖ URL successfully cleaned of sensitive parameters');
              } else {
                console.error('‚ùå URL still contains sensitive parameters');
              }
              displayUrlParams();
            }, 100);
          } else {
            updateStatus('‚ùå OAuth auto-detection failed - session not saved', 'error');
          }
        }
        
        await checkSession();
      }, 100);
    }
    
    init();
  </script>
</body>
</html>